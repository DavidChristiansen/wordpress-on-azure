# Build numbering format
name: $(BuildID)

trigger:
  - feat/docker-hub
  # - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: image-name
    value: onazureio/wordpress

  - name: image-tag
    value: 'dev'

  - name: registry-connection
    value: onazureio-docker-hub-connection

  # git

  - name: is-dev
    value: ${{ eq(variables['Build.SourceBranch'], 'refs/heads/dev') }}

  - name: is-production
    value: ${{ eq(variables['Build.SourceBranch'], 'refs/heads/production') }}

  - name: is-deployment
    value: ${{ and(or(variables['is-dev'], variables['is-production']), ne(variables['Build.Reason'], 'Schedule'),  ne(variables['Build.Reason'], 'PullRequest')) }}

stages:
- stage: docker
  displayName: 'Docker'
  condition: ${{ variables['is-deployment'] }}
  jobs:
  - job: docker
    displayName: Build and Push
    steps:

    - task: Docker@2
      displayName: Login to Docker Hub
      inputs:
        command: login
        containerRegistry: $(registry-connection)

    - task: Docker@2
      displayName: Build and Push
      inputs:
        command: buildAndPush
        repository: $(image-name)
        # N.B. tag must be multi-line string
        tags: |
          $(image-tag)

    - task: Docker@2
      displayName: Logout
      inputs:
        command: logout
        containerRegistry: $(registry-connection)
